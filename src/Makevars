# 1. Path definitions
# Get the current directory path of the Makevars
CURRENT_DIR := $(CURDIR)
PARENT_DIR  := $(shell dirname $(CURRENT_DIR))
# Get the parent of the parent directory path
PARENT_OF_PARENT_DIR := $(shell dirname $(PARENT_DIR))
ephoto_path := $(PARENT_OF_PARENT_DIR)/ePhotosynthesis_C
ABS_EPHOTO_PATH := $(abspath $(ephoto_path)/build)

#conda_path := $(shell conda env list | grep ephoto | awk '{print $$NF}')
#
# 2. Compiler Flags
PKG_CPPFLAGS += -I$(ephoto_path)/include -I$(ephoto_path)/build 
#PKG_CPPFLAGS += -I$(CURDIR)/../inc
PKG_CPPFLAGS += -DR_NO_REMAP 
PKG_CXXFLAGS += -O3 -g -Wall -ggdb3 -std=c++17

# 3. Try to get sundials paths from pkg-config
PKG_CONFIG_INC = $(shell pkg-config --cflags sundials 2>/dev/null)
PKG_CONFIG_LIB = $(shell pkg-config --libs sundials 2>/dev/null)
BREW_INC = -I/opt/homebrew/include
BREW_LIB = -L/opt/homebrew/lib -lsundials_cvode -lsundials_nvecserial
PKG_CPPFLAGS += $(if $(PKG_CONFIG_INC), $(PKG_CONFIG_INC), $(BREW_INC))
PKG_LIBS += $(if $(PKG_CONFIG_LIB), $(PKG_CONFIG_LIB), $(BREW_LIB))

# 4. EPhotosynthesis Linking & Rpath
PKG_LIBS += -Wl,-rpath,$(ABS_EPHOTO_PATH) -L$(ABS_EPHOTO_PATH) -lEPhotosynthesis 

# 5. Source/Object setup
SOURCES = $(wildcard *.cpp module_library/*.cpp framework/*.cpp framework/ode_solver_library/*.cpp framework/utils/*.cpp)
OBJECTS = $(SOURCES:.cpp=.o)
SHLIB = BMLePhoto.so

# 6. The "Hard-Link" Fix for macOS
all: $(SHLIB)
	@if [ "$(shell uname)" = "Darwin" ]; then \
                echo "Fixing macOS library link for: $(SHLIB)"; \
		install_name_tool -change "@rpath/libEPhotosynthesis.dylib" \
		"$(ABS_EPHOTO_PATH)/libEPhotosynthesis.dylib" \
		$(SHLIB); \
	fi

# --- Dependency Generation Logic ---
DEPDIR := .deps
DEPSUBDIRS = $(DEPDIR)/module_library $(DEPDIR)/framework $(DEPDIR)/framework/ode_solver_library $(DEPDIR)/framework/utils

DEPFLAGS = -MT $@ -MMD -MP -MF $(DEPDIR)/$*.d

OUTPUT_OPTION = -o $@
COMPILE.cpp = $(CXX) $(DEPFLAGS) $(ALL_CPPFLAGS) $(ALL_CXXFLAGS) -c

$(OBJECTS) : %.o : %.cpp $(DEPDIR)/%.d | $(DEPSUBDIRS)
	$(COMPILE.cpp) $< $(OUTPUT_OPTION)

$(DEPSUBDIRS):
	@mkdir -p $@

DEPFILES := $(SOURCES:%.cpp=$(DEPDIR)/%.d)
$(DEPFILES):

include $(wildcard $(DEPFILES))
